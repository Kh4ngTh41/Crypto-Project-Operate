<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giải mã & Xác thực giao dịch</title>
    <link rel="stylesheet" href="static/main.css"> <!-- Đã cập nhật đường dẫn CSS -->
</head>
<body>
    <div class="container">
        <h2>Giải mã & Xác thực giao dịch</h2>
        <p>Bạn đang giải mã với vai trò người bán: <strong id="current_user_display"></strong></p>
        <form id="decryptVerifyForm">
            <label>Nhập tên file giao dịch đã mã hóa (.encrypted) từ thư mục transactions:</label>
            <input type="text" id="encrypted_file_name" placeholder="Ví dụ: transaction_orderabc_12345.encrypted" required>
            
            <label>Tên người nhận (người bán - sẽ tự động là tài khoản hiện tại):</label>
            <input type="text" id="receiver_name_display" disabled>
            <input type="hidden" id="receiver_name">

            <label>Passphrase RSA:</label>
            <input type="password" id="rsa_passphrase" required>
            <button type="submit">Giải mã & Xác thực</button>
        </form>
        <div id="result"></div>
        <a href="index.html">Quay lại Dashboard</a>
    </div>
    <script>
        const backendBaseUrl = "http://127.0.0.1:5560";
        const appHelperBaseUrl = "http://127.0.0.1:8080";
        let currentUsername = null;

        window.onload = async () => {
            const res = await fetch(`${backendBaseUrl}/api/check_login_status`, {
                credentials: 'include'
            });
            const data = await res.json();
            if (data.logged_in) {
                currentUsername = data.username;
                document.getElementById('current_user_display').innerText = currentUsername;
                document.getElementById('receiver_name_display').value = currentUsername;
                document.getElementById('receiver_name').value = currentUsername;
            } else {
                window.location.href = 'login.html';
            }
        };

        document.getElementById('decryptVerifyForm').onsubmit = async (e) => {
            e.preventDefault();
            const encrypted_file_name = document.getElementById('encrypted_file_name').value;
            const receiver_name = document.getElementById('receiver_name').value;
            const rsa_passphrase = document.getElementById('rsa_passphrase').value;

            if (!encrypted_file_name) {
                document.getElementById('result').innerText = 'Vui lòng nhập tên file mã hóa.';
                return;
            }

            document.getElementById('result').innerText = 'Đang tải file mã hóa từ server...';

            try {
                // Bước 1: Gửi tên file mã hóa lên backend để backend đọc và trả về nội dung JSON
                const formDataToBackend = new FormData();
                formDataToBackend.append("file_id", encrypted_file_name);
                formDataToBackend.append("receiver_name", receiver_name); // Gửi receiver_name để backend kiểm tra quyền

                const backendRes = await fetch(`${backendBaseUrl}/api/decrypt_verify`, { 
                    method: "POST",
                    body: formDataToBackend,
                    credentials: 'include' // Gửi session cookie
                });
                const backendData = await backendRes.json();

                if (!backendRes.ok || !backendData.success) {
                    document.getElementById('result').innerText = `Lỗi backend khi tải file mã hóa: ${backendData.message || 'Unknown error'}`;
                    return;
                }
                const encrypted_data = backendData.encrypted_data; // Dữ liệu mã hóa từ backend

                document.getElementById('result').innerText = 'Đang giải mã trên máy client...';

                // Bước 2: Gọi App Helper để giải mã
                const clientDecryptRes = await fetch(`${appHelperBaseUrl}/decrypt_transaction`, { 
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        encrypted_data: encrypted_data,
                        receiver_name: receiver_name,
                        rsa_passphrase: rsa_passphrase
                    })
                });
                const clientDecryptData = await clientDecryptRes.json();

                if (!clientDecryptRes.ok || !clientDecryptData.success) {
                    document.getElementById('result').innerText = `Lỗi giải mã trên client: ${clientDecryptData.message || 'Unknown error'}`;
                    return;
                }

                document.getElementById('result').innerText = 'Đã giải mã trên client. Đang gửi kết quả về server để hiển thị/xác thực...';

                // Bước 3: Gửi dữ liệu đã giải mã về Backend để hiển thị và xác thực chữ ký
                const finalVerifyRes = await fetch(`${backendBaseUrl}/api/submit_decrypted_transaction`, { 
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        decrypted_package: clientDecryptData.decrypted_package
                    }),
                    credentials: 'include' // Gửi session cookie
                });
                const finalVerifyData = await finalVerifyRes.json();

                if (finalVerifyRes.ok && finalVerifyData.success) {
                    let verifyStatus = finalVerifyData.verify_results.map(res =>
                        `${res.algo} (${res.signer}, ${res.fingerprint}): ${res.valid ? 'HỢP LỆ' : 'KHÔNG HỢP LỆ'}`
                    ).join('<br>');
                    document.getElementById('result').innerHTML = `Giải mã & Xác thực thành công!<br><h3>Nội dung giao dịch:</h3><pre>${JSON.stringify(finalVerifyData.order, null, 2)}</pre><h3>Kết quả xác thực chữ ký:</h3>${verifyStatus}`;
                } else {
                    document.getElementById('result').innerText = `Lỗi khi xác thực trên server: ${finalVerifyData.message || 'Unknown error'}`;
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerText = `Lỗi kết nối hoặc xử lý: ${error.message}`;
            }
        }
    </script>
</body>
</html>
